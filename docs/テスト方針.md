# テスト方針

## 概要
このドキュメントでは、`mysql-schema-mcp` のハンドラー機能に対するテスト方針を記述します。
まずは `ListTables` メソッドの正常系テストから開始します。

## テスト環境

### 新しいアプローチ
- ローカル開発環境とCI環境で `docker-compose up -d` コマンド等で起動したMySQLコンテナを使用する
  - ローカル開発環境: 開発者が `docker-compose.yml` を元に起動したMySQLコンテナ
  - CI環境: GitHub Actions のワークフロー内で `docker-compose up -d` を実行してMySQLコンテナを起動
- 各テストケースごとに一意のデータベースを作成し、テスト終了後に削除する
- テスト用DB接続情報は本番環境と同じ環境変数を使用
  - `DB_HOST`, `DB_PORT`, `DB_USER`, `DB_PASSWORD`
  - `docker-compose.yml` で設定された値に対応する環境変数を設定してテストを実行する。（例: `DB_HOST=localhost`, `DB_PORT=13306`, `DB_USER=root`, `DB_PASSWORD=rootpass`）

### テスト向けユーティリティ
- `setupTestDB`: `docker-compose` で起動したMySQLインスタンスに接続し、テスト用のデータベースを作成して接続を返す。テスト終了時にデータベースを削除するクリーンアップ処理も登録する。
- `applySchema`: SQLファイルからスキーマを適用

## 1. `ListTables` メソッド テスト

### 1.1. テスト目的
- `docs/requirements.md` に記載された出力フォーマットに従って、テーブル情報が正しく整形されて返却されることを確認する。
- 単一キー、複合キー（PK, UK, FK）、複数のキー制約（とくにUK）を含むさまざまなテーブル構成に対応できることを確認する。

### 1.2. テスト環境
- `docker-compose` で起動したMySQLサーバーに対してテストを実行する
- テストの検証には以下のライブラリを使用する
  - `stretchr/testify`: アサーション（期待値との比較）を容易にするため
- テストの準備（テストDB作成、スキーマ適用）と後片付け（DB削除）を行うヘルパー関数 (`setupTestDB`) を使用する

### 1.3. テストケース: 複合キーおよび複数UKを含むテーブル構成

#### 1.3.1. テスト用テーブルスキーマ
以下のCREATE TABLE文で定義される4つのテーブルを持つデータベースを各テストごとに用意する。

```sql
-- orders テーブル（order_items からの参照用）
CREATE TABLE orders (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT '注文ID',
    order_date DATETIME COMMENT '注文日時',
    INDEX(id) -- 複合外部キーの参照先としてインデックスが必要
) COMMENT='注文ヘッダー';

-- users テーブル
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT 'ユーザーシステムID',
    email VARCHAR(255) NOT NULL UNIQUE COMMENT 'メールアドレス',
    username VARCHAR(255) NOT NULL UNIQUE COMMENT 'ユーザー名',
    tenant_id INT NOT NULL COMMENT 'テナントID',
    employee_id INT NOT NULL COMMENT '従業員ID',
    UNIQUE KEY uk_tenant_employee (tenant_id, employee_id) -- 複合一意キー
) COMMENT='ユーザー情報';

-- products テーブル
CREATE TABLE products (
    product_code VARCHAR(50) PRIMARY KEY COMMENT '商品コード（主キー）',
    maker_code VARCHAR(50) NOT NULL COMMENT 'メーカーコード',
    internal_code VARCHAR(50) NOT NULL COMMENT '社内商品コード',
    product_name VARCHAR(255) COMMENT '商品名', -- 例としてカラム追加
    UNIQUE KEY uk_maker_internal (maker_code, internal_code) -- 複合一意キー
) COMMENT='商品マスター';

-- order_items テーブル
CREATE TABLE order_items (
    order_id INT NOT NULL COMMENT '注文ID (FK)',
    item_seq INT NOT NULL COMMENT '注文明細連番',
    product_maker VARCHAR(50) NOT NULL COMMENT '商品メーカーコード (FK)',
    product_internal_code VARCHAR(50) NOT NULL COMMENT '商品社内コード (FK)',
    quantity INT NOT NULL COMMENT '数量', -- 例としてカラム追加
    PRIMARY KEY (order_id, item_seq), -- 複合主キー
    UNIQUE KEY uk_order_product (order_id, product_maker, product_internal_code), -- 複合一意キー （注文内での同一商品は許さない）
    FOREIGN KEY fk_order (order_id) REFERENCES orders(id) ON DELETE CASCADE, -- 単一外部キー （注文が消えたら明細も消す例）
    FOREIGN KEY fk_product (product_maker, product_internal_code) REFERENCES products(maker_code, internal_code) -- 複合外部キー
) COMMENT='注文明細';
```

#### 1.3.2. 実行手順
1. `docker-compose up -d` コマンド等でテスト用のMySQLコンテナを起動する
2. テストコード内で `setupTestDB` を呼び出し、テスト用DBを作成し、スキーマを適用する
3. `ListTables` ツールを `dbName: "{テスト用DB名}"` で呼び出す
4. 返却されたテキストが期待される出力と一致することを確認する
5. テスト完了後、`setupTestDB` 内で登録されたクリーンアップ処理によりテスト用DBが自動的に削除される
6. (必要に応じて `docker-compose down` でコンテナを停止する)

#### 1.3.3. 期待される出力

```
データベース「{テスト用DB名}」のテーブル一覧 (全4件)
フォーマット: テーブル名 - テーブルコメント [PK: 主キー] [UK: 一意キー1; 一意キー2...] [FK: 外部キー -> 参照先テーブル.カラム; ...]
※ 複合キー（複数カラムで構成されるキー）は括弧でグループ化: (col1, col2)
※ 複数の異なるキー制約はセミコロンで区切り: key1; key2

- order_items - 注文明細 [PK: (order_id, item_seq)] [UK: (order_id, product_maker, product_internal_code)] [FK: order_id -> orders.id; (product_maker, product_internal_code) -> products.(maker_code, internal_code)]
- orders - 注文ヘッダー [PK: id]
- products - 商品マスター [PK: product_code] [UK: (maker_code, internal_code)]
- users - ユーザー情報 [PK: id] [UK: email; (tenant_id, employee_id); username]
```

## 2. 今後のテスト項目（検討中）
- `DescribeTables` メソッドのテスト
- エラーケースのテスト（DB接続エラー、存在しないDB/テーブル指定など）
- 特殊文字を含むテーブル/カラム名/コメントのテスト

## 実装 TODO リスト

1. [x] テストヘルパーファイル (`testhelper_test.go`) を作成し、`setupTestDB` 関数を実装する (スキーマ適用も含む)
2. [x] テストデータのSQLファイル (`testdata/schema.sql`) を作成する
3. [x] `handler_test.go` を作成し、`TestListTables` 関数を実装する
4. [x] ローカル環境でテストを実行し確認する (`docker-compose` でMySQLを起動しておく必要がある)
5. [ ] GitHub Actions用の設定ファイルを作成して、CI環境でもテストが実行できることを確認する (`docker-compose` を利用する設定を追加)
