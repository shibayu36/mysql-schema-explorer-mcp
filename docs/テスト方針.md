# テスト方針

## 概要
このドキュメントでは、`mysql-schema-mcp` のハンドラー機能に対するテスト方針を記述します。
まずは `ListTables` メソッドの正常系テストから開始します。

## 1. `ListTables` メソッド テスト

### 1.1. テスト目的
- `docs/requirements.md` に記載された出力フォーマットに従って、テーブル情報が正しく整形されて返却されることを確認する。
- 単一キー、複合キー（PK, UK, FK）、複数のキー制約（とくにUK）を含むさまざまなテーブル構成に対応できることを確認する。

### 1.2. テスト環境
- Dockerを使用してMySQLテスト環境を構築し、実際のデータベースに対してテストを実行する。
- テストの実行と検証には以下のライブラリを使用する。
    - `ory/dockertest`: テスト用のMySQLコンテナを管理するため。
    - `stretchr/testify`: アサーション（期待値との比較）を容易にするため。
- テストの準備（DBコンテナ起動、スキーマ適用）と後片付け（コンテナ停止）を行うヘルパー関数を `testhelper_test.go` に実装する。

### 1.3. テストケース: 複合キーおよび複数UKを含むテーブル構成

#### 1.3.1. テスト用テーブルスキーマ
以下のCREATE TABLE文で定義される3つのテーブル（+参照用ordersテーブル）を持つデータベース(`test_db`とする）を用意する。

```sql
-- orders テーブル（order_items からの参照用）
CREATE TABLE orders (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT '注文ID',
    order_date DATETIME COMMENT '注文日時',
    INDEX(id) -- 複合外部キーの参照先としてインデックスが必要
) COMMENT='注文ヘッダー';

-- users テーブル
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT 'ユーザーシステムID',
    email VARCHAR(255) NOT NULL UNIQUE COMMENT 'メールアドレス',
    username VARCHAR(255) NOT NULL UNIQUE COMMENT 'ユーザー名',
    tenant_id INT NOT NULL COMMENT 'テナントID',
    employee_id INT NOT NULL COMMENT '従業員ID',
    UNIQUE KEY uk_tenant_employee (tenant_id, employee_id) -- 複合一意キー
) COMMENT='ユーザー情報';

-- products テーブル
CREATE TABLE products (
    product_code VARCHAR(50) PRIMARY KEY COMMENT '商品コード（主キー）',
    maker_code VARCHAR(50) NOT NULL COMMENT 'メーカーコード',
    internal_code VARCHAR(50) NOT NULL COMMENT '社内商品コード',
    product_name VARCHAR(255) COMMENT '商品名', -- 例としてカラム追加
    UNIQUE KEY uk_maker_internal (maker_code, internal_code) -- 複合一意キー
) COMMENT='商品マスター';

-- order_items テーブル
CREATE TABLE order_items (
    order_id INT NOT NULL COMMENT '注文ID (FK)',
    item_seq INT NOT NULL COMMENT '注文明細連番',
    product_maker VARCHAR(50) NOT NULL COMMENT '商品メーカーコード (FK)',
    product_internal_code VARCHAR(50) NOT NULL COMMENT '商品社内コード (FK)',
    quantity INT NOT NULL COMMENT '数量', -- 例としてカラム追加
    PRIMARY KEY (order_id, item_seq), -- 複合主キー
    UNIQUE KEY uk_order_product (order_id, product_maker, product_internal_code), -- 複合一意キー （注文内での同一商品は許さない）
    FOREIGN KEY fk_order (order_id) REFERENCES orders(id) ON DELETE CASCADE, -- 単一外部キー （注文が消えたら明細も消す例）
    FOREIGN KEY fk_product (product_maker, product_internal_code) REFERENCES products(maker_code, internal_code) -- 複合外部キー
) COMMENT='注文明細';
```

#### 1.3.2. 実行手順
1. テスト用DBに上記のスキーマでテーブルを作成する。
2. `ListTables` ツールを `dbName: "test_db"` で呼び出す。
3. 返却されたテキストが以下の期待される出力と一致することを確認する。

#### 1.3.3. 期待される出力

```
データベース「test_db」のテーブル一覧 (全3件)
フォーマット: テーブル名 - テーブルコメント [PK: 主キー] [UK: 一意キー1; 一意キー2...] [FK: 外部キー -> 参照先テーブル.カラム; ...]
※ 複合キー（複数カラムで構成されるキー）は括弧でグループ化: (col1, col2)
※ 複数の異なるキー制約はセミコロンで区切り: key1; key2

- users - ユーザー情報 [PK: id] [UK: email; username; (tenant_id, employee_id)]
- products - 商品マスター [PK: product_code] [UK: (maker_code, internal_code)]
- order_items - 注文明細 [PK: (order_id, item_seq)] [UK: (order_id, product_maker, product_internal_code)] [FK: order_id -> orders.id; (product_maker, product_internal_code) -> products.(maker_code, internal_code)]
```

## 2. 今後のテスト項目（検討中）
- `DescribeTables` メソッドのテスト
- エラーケースのテスト（DB接続エラー、存在しないDB/テーブル指定など）
- 特殊文字を含むテーブル/カラム名/コメントのテスト

## 実装 TODO リスト

1. [ ] テストヘルパーファイル (`testhelper_test.go`) を作成し、`setupTestDB` 関数を実装する。
2. [ ] `handler_test.go` を作成し、`TestListTables` 関数を実装する。
3. [ ] `go test` で `TestListTables` を実行し、成功することを確認する。
